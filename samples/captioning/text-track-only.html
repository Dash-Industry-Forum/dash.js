<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Text track streaming</title>

    <script src="../../dist/dash.all.debug.js"></script>
    <script src="./FakeHTMLMediaElement.js"></script>

    <!-- Bootstrap core CSS -->
    <link href="../lib/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="../lib/main.css" rel="stylesheet">

    <style>
        video {
            width: 640px;
            height: 360px;
        }
    </style>

    <script class="code">
        var //url = "https://livesim.dashif.org/dash/vod/testpic_2s/multi_subs.mpd",
            // url = "https://dash.akamaized.net/akamai/test/caption_test/ElephantsDream/elephants_dream_480p_heaac5_1.mpd",
            // url = "https://livesim.dashif.org/livesim/testpic_2s/cea608.mpd",
            url = "https://broadpeak.e2e.purpledrm.com:8443/direct-origin-proj/bpk-tv/ArteLoop/clear/manifest.mpd",
            TTMLRenderingDiv,
            mediaSource,
            video,
            player,
            time,
            intervalId;

        function init() {

            TTMLRenderingDiv = document.querySelector("#ttml-rendering-div"),
            mediaSource = new FakeMediaSource();
            video = new FakeHTMLMediaElement(document.querySelector("#videoContainer"));

            player = dashjs.MediaPlayer({}).create();
            player.updateSettings({ debug: { logLevel: 5 }});

            player.extend("MediaSourceController", function () {
                return {
                    createMediaSource: function (xhr) {
                        return mediaSource;
                    },
                    attachMediaSource: function (videoModel) {
                        mediaSource.open();
                    }
                };
            }, true);

            player.on('captionRendered', onCaptionRendered);

            player.initialize(video);
            player.attachTTMLRenderingDiv(TTMLRenderingDiv);
            player.attachSource(url);

            // time = 0;
            // start();

            time = (Date.now() / 1000) - 10;
            seek(time);
        }

        function onCaptionRendered() {
            var textTracks = video.textTracks;
            textTrack = textTracks.filter(track => track.mode === 'showing')[0];
            if (textTrack.isTTML) return;
            textTrack.activeCues.forEach(cue => {
                document.querySelector("#ttml-rendering-div").innerText = cue.text;
                console.log(cue.text);
            });
        }

        function start() {
            intervalId = setInterval(function() {
                time += 1;
                video.updateCurrentTime(time);
            }, 1000);
        }

        function pause() {
            clearInterval(intervalId);
        }

        function stop() {
            pause();
            player.attachSource(null);
        }

        function seek(seekTime) {
            clearInterval(intervalId);
            video.currentTime = seekTime;
            time = seekTime;
            start();
        }

    </script>
</head>
<body>

<main>
    <div class="container py-4">
        <header class="pb-3 mb-4 border-bottom">
            <img class=""
                 src="../lib/img/dashjs-logo.png"
                 width="200">
        </header>
        <div class="row">
            <div class="col-md-4">
                <div class="h-100 p-5 bg-light border rounded-3">
                    <h3>Text tracks streaming Demo</h3>
                    <p>This example shows how to stream and display text tracks without audio/video streaming (no video element)</p>
                </div>
            </div>
            <div id="videoContainer" class="col-md-8">
                <!-- <video controls="true"></video> -->
                <div id="ttml-rendering-div">
                    <span id="vtt-span">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div id="code-output"></div>
            </div>
        </div>
        <footer class="pt-3 mt-4 text-muted border-top">
            &copy; DASH-IF
        </footer>
    </div>
</main>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        init();
    });
</script>
<script src="../highlighter.js"></script>
</body>
</html>
