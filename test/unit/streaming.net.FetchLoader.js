import FetchLoader from '../../src/streaming/net/FetchLoader';
import Constants from '../../src/streaming/constants/Constants';

const expect = require('chai').expect;

const context = {};

let fetchLoader;

describe('FetchLoader', function () {
    it('should calculate the proper download time based on fetch progress datum', () => {
        const calculationMode = Constants.ABR_FETCH_THROUGHPUT_CALCULATION_DOWNLOADED_DATA;
        fetchLoader = FetchLoader(context).create({});

        // 1MB test, 2.4MB received
        const Data1MB = '[{"ts":1529393808348,"bytes":16384},{"ts":1529393808617,"bytes":32768},{"ts":1529393808864,"bytes":32768},{"ts":1529393809121,"bytes":32768},{"ts":1529393809378,"bytes":32768},{"ts":1529393809637,"bytes":32768},{"ts":1529393809942,"bytes":32768},{"ts":1529393810258,"bytes":32768},{"ts":1529393810516,"bytes":32768},{"ts":1529393810762,"bytes":32759},{"ts":1529393811020,"bytes":32768},{"ts":1529393811326,"bytes":32768},{"ts":1529393811582,"bytes":32768},{"ts":1529393811840,"bytes":32768},{"ts":1529393812099,"bytes":32768},{"ts":1529393812380,"bytes":32768},{"ts":1529393812508,"bytes":16393},{"ts":1529393812766,"bytes":32768},{"ts":1529393813023,"bytes":32768},{"ts":1529393813327,"bytes":32759},{"ts":1529393813585,"bytes":32768},{"ts":1529393813843,"bytes":32768},{"ts":1529393814090,"bytes":32768},{"ts":1529393814384,"bytes":32768},{"ts":1529393814641,"bytes":32768},{"ts":1529393814899,"bytes":32768},{"ts":1529393815191,"bytes":32768},{"ts":1529393815449,"bytes":32768},{"ts":1529393815708,"bytes":32759},{"ts":1529393815954,"bytes":32768},{"ts":1529393816233,"bytes":32768},{"ts":1529393816492,"bytes":32768},{"ts":1529393816750,"bytes":32768},{"ts":1529393816751,"bytes":18},{"ts":1529393817007,"bytes":32768},{"ts":1529393817264,"bytes":32768},{"ts":1529393817510,"bytes":32768},{"ts":1529393817792,"bytes":32768},{"ts":1529393818075,"bytes":32759},{"ts":1529393818368,"bytes":32768},{"ts":1529393818626,"bytes":32768},{"ts":1529393818883,"bytes":32768},{"ts":1529393819174,"bytes":32768},{"ts":1529393819422,"bytes":32768},{"ts":1529393819679,"bytes":32768},{"ts":1529393819937,"bytes":32768},{"ts":1529393820241,"bytes":32768},{"ts":1529393820499,"bytes":32759},{"ts":1529393820758,"bytes":32768},{"ts":1529393821004,"bytes":32768},{"ts":1529393821006,"bytes":18},{"ts":1529393821332,"bytes":32768},{"ts":1529393821589,"bytes":32768},{"ts":1529393821848,"bytes":32768},{"ts":1529393822104,"bytes":32768},{"ts":1529393822398,"bytes":32768},{"ts":1529393822656,"bytes":32768},{"ts":1529393822903,"bytes":32768},{"ts":1529393823193,"bytes":32759},{"ts":1529393823453,"bytes":32768},{"ts":1529393823710,"bytes":32768},{"ts":1529393823968,"bytes":32768},{"ts":1529393824261,"bytes":32768},{"ts":1529393824506,"bytes":32768},{"ts":1529393824766,"bytes":32768},{"ts":1529393825022,"bytes":32768},{"ts":1529393825280,"bytes":32768},{"ts":1529393825282,"bytes":9},{"ts":1529393825538,"bytes":32759},{"ts":1529393825797,"bytes":32768},{"ts":1529393826090,"bytes":32768},{"ts":1529393826382,"bytes":32768},{"ts":1529393826639,"bytes":32768},{"ts":1529393826897,"bytes":32768},{"ts":1529393827191,"bytes":32768},{"ts":1529393827448,"bytes":32768},{"ts":1529393827706,"bytes":32768},{"ts":1529393827800,"bytes":13409}]';
        let result1MB = fetchLoader.calculateDownloadedTime(calculationMode,[], [], JSON.parse(Data1MB), 2405464);

        const Data300MB = '[{"ts":1529394745999,"bytes":32768},{"ts":1529394746180,"bytes":32768},{"ts":1529394746182,"bytes":32768},{"ts":1529394746359,"bytes":32768},{"ts":1529394746361,"bytes":65536},{"ts":1529394746363,"bytes":16384},{"ts":1529394746537,"bytes":16384},{"ts":1529394746538,"bytes":65536},{"ts":1529394746540,"bytes":38539},{"ts":1529394746718,"bytes":32768},{"ts":1529394746720,"bytes":65536},{"ts":1529394746720,"bytes":32768},{"ts":1529394746897,"bytes":32768},{"ts":1529394746899,"bytes":26997},{"ts":1529394746900,"bytes":5771},{"ts":1529394746903,"bytes":65536},{"ts":1529394747072,"bytes":5771},{"ts":1529394747098,"bytes":49152},{"ts":1529394747099,"bytes":16384},{"ts":1529394747101,"bytes":65536},{"ts":1529394747274,"bytes":32768},{"ts":1529394747275,"bytes":65536},{"ts":1529394747277,"bytes":49152},{"ts":1529394747453,"bytes":22155},{"ts":1529394748096,"bytes":32761},{"ts":1529394748098,"bytes":16391},{"ts":1529394748099,"bytes":16384},{"ts":1529394748273,"bytes":32768},{"ts":1529394748275,"bytes":16384},{"ts":1529394748277,"bytes":31839},{"ts":1529394748279,"bytes":33697},{"ts":1529394748452,"bytes":32768},{"ts":1529394748454,"bytes":16384},{"ts":1529394748456,"bytes":65536},{"ts":1529394748458,"bytes":5771},{"ts":1529394749095,"bytes":16384},{"ts":1529394749097,"bytes":32768},{"ts":1529394749279,"bytes":16384},{"ts":1529394749279,"bytes":32768},{"ts":1529394749281,"bytes":65536},{"ts":1529394749283,"bytes":16384},{"ts":1529394749458,"bytes":32768},{"ts":1529394749460,"bytes":65536},{"ts":1529394749461,"bytes":22155},{"ts":1529394750095,"bytes":32761},{"ts":1529394750096,"bytes":7},{"ts":1529394750097,"bytes":16384},{"ts":1529394750273,"bytes":20297},{"ts":1529394750275,"bytes":28855},{"ts":1529394750276,"bytes":65536},{"ts":1529394750452,"bytes":32768},{"ts":1529394750454,"bytes":65536},{"ts":1529394750455,"bytes":16384},{"ts":1529394750551,"bytes":16384},{"ts":1529394750628,"bytes":5771},{"ts":1529394751095,"bytes":32761},{"ts":1529394751097,"bytes":7},{"ts":1529394751099,"bytes":16384},{"ts":1529394751275,"bytes":65536},{"ts":1529394751277,"bytes":65536},{"ts":1529394751452,"bytes":32768},{"ts":1529394751454,"bytes":65536},{"ts":1529394751455,"bytes":14526},{"ts":1529394751456,"bytes":7629},{"ts":1529394752095,"bytes":16384},{"ts":1529394752098,"bytes":32768},{"ts":1529394752273,"bytes":32768},{"ts":1529394752276,"bytes":65536},{"ts":1529394752277,"bytes":32768},{"ts":1529394752451,"bytes":32768},{"ts":1529394752454,"bytes":65536},{"ts":1529394752466,"bytes":22155}]';
        let result300MB = fetchLoader.calculateDownloadedTime(calculationMode,[], [], JSON.parse(Data300MB), 2405464);
        expect(result1MB).to.be.above(10000);
        expect(result300MB).to.be.below(200);
    });
});
