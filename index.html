<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Dash JavaScript Player</title>
    <meta name="description" content="" />

    <style type="text/css" title="currentStyle">
        @import "app/lib/datatables/media/css/demo_table_jui.css";
	    @import "app/lib/jquery/css/smoothness/jquery-ui-1.9.2.custom.min.css";
        @import "app/css/960/reset.css";
        @import "app/css/960/text.css";
        @import "app/css/960/960.css";
        @import "app/css/main.css";
    </style>

	<!-- Libraries -->

    <script src="app/lib/jquery/js/jquery-1.8.3.min.js"></script>
    <script src="app/lib/jquery/js/jquery-ui-1.9.2.custom.min.js"></script>
    <script src="app/lib/highcharts/highcharts.js"></script>
    <script src="app/lib/highcharts/modules/exporting.js"></script>
    <script src="app/lib/datatables/media/js/jquery.dataTables.js"></script>

	<script src="app/lib/xml2json.js"></script>
	<script src="app/lib/objectiron.js"></script>
	<script src="app/lib/long.js"></script>
	<script src="app/lib/Math.js"></script>

	<!-- https://github.com/kriskowal/q -->
	<script src="app/lib/q.js"></script>

	<!-- https://github.com/creynders/dijon-framework -->
	<script src="app/lib/dijon.js"></script>

	<!-- Player -->

	<script src="app/js/streaming/MediaPlayer.js"></script>
	<script src="app/js/streaming/Context.js"></script>
	<script src="app/js/streaming/Capabilities.js"></script>
	<script src="app/js/streaming/Debug.js"></script>
	<script src="app/js/streaming/VideoModel.js"></script>
	<script src="app/js/streaming/vo/SegmentRequest.js"></script>
	<script src="app/js/streaming/ManifestLoader.js"></script>
	<script src="app/js/streaming/MediaSourceExtensions.js"></script>
	<script src="app/js/streaming/SourceBufferExtensions.js"></script>
	<script src="app/js/streaming/BufferExtensions.js"></script>
	<script src="app/js/streaming/FragmentController.js"></script>
	<script src="app/js/streaming/AbrController.js"></script>
	<script src="app/js/streaming/FragmentLoader.js"></script>
	<script src="app/js/streaming/Stream.js"></script>
	<script src="app/js/streaming/BufferController.js"></script>
	<script src="app/js/streaming/rules/BandwidthRule.js"></script>
	<script src="app/js/streaming/rules/BaseRulesCollection.js"></script>

	<!-- Metrics -->

	<script src="app/js/streaming/vo/MetricsList.js"></script>
	<script src="app/js/streaming/MetricsModel.js"></script>
	<script src="app/js/streaming/vo/metrics/BufferLevel.js"></script>
	<script src="app/js/streaming/vo/metrics/HTTPRequest.js"></script>
	<script src="app/js/streaming/vo/metrics/PlayList.js"></script>
	<script src="app/js/streaming/vo/metrics/RepresentationSwitch.js"></script>
	<script src="app/js/streaming/vo/metrics/TCPConnection.js"></script>

	<!-- Dash -->

	<script src="app/js/dash/Dash.js"></script>
	<script src="app/js/dash/DashContext.js"></script>
	<script src="app/js/dash/vo/Segment.js"></script>
	<script src="app/js/dash/DashParser.js"></script>
	<script src="app/js/dash/DashHandler.js"></script>
	<script src="app/js/dash/BaseURLExtensions.js"></script>
	<script src="app/js/dash/FragmentExtensions.js"></script>
	<script src="app/js/dash/DashManifestExtensions.js"></script>

    <!-- TODO : Make into main.js. -->
    <script>
        var player;
        //var ui;
        var time = -1;

        var videoBufferChart;
        var audioBufferChart;

        function buildVideoBufferGraph()
        {
            videoBufferChart = new Highcharts.Chart({
                chart: {
                    renderTo: 'video-buffer-container',
                    spacingRight: 20
                },
                title: {
                    text: 'Video Buffer'
                },
                xAxis: {
                    type: 'time',
                    tickPixelInterval: 100
                },
                yAxis: {
                    title: {
                        text: null
                    },
                    min: 0
                },
                tooltip: {
                    shared: true
                },
                legend: {
                    enabled: false
                },
                plotOptions: {
                    line: {
                        dataLabels: {
                            enabled: true
                        },
                        enableMouseTracking: false
                    }
                },
                exporting: {
                    enabled: false
                },
                printing: {
                    enabled: false
                },
                series: [{
                    name: 'avgfps',
                    data: (function () {
                        // generate an array of random data
                        var data = [];
                        for (var i = 0; i < 7; i++) {
                            data.push({ x: 0, y: 0 });
                        }
                        return data;
                    })()
                }]
            });
        }

        function buildAudioBufferGraph() {
            audioBufferChart = new Highcharts.Chart({
                chart: {
                    renderTo: 'audio-buffer-container',
                    spacingRight: 20
                },
                title: {
                    text: 'Audio Buffer'
                },
                xAxis: {
                    type: 'time',
                    tickPixelInterval: 100
                },
                yAxis: {
                    title: {
                        text: null
                    },
                    min: 0
                },
                tooltip: {
                    shared: true
                },
                legend: {
                    enabled: false
                },
                plotOptions: {
                    line: {
                        dataLabels: {
                            enabled: true
                        },
                        enableMouseTracking: false
                    }
                },
                exporting: {
                    enabled: false
                },
                printing: {
                    enabled: false
                },
                series: [{
                    name: 'avgfps',
                    data: (function () {
                        // generate an array of random data
                        var data = [];
                        for (var i = 0; i < 7; i++) {
                            data.push({ x: 0, y: 0 });
                        }
                        return data;
                    })()
                }]
            });
        }

        function buildTables()
        {
            $.extend($.fn.dataTable.defaults, {
                "bFilter": false,
                "bSort": false,
                "bPaginate": false,
                "bInfo": false
            });

            $(document).ready(function () {
                $('#metrics-table').dataTable({
                    "bJQueryUI": true
                });
            });
        }

        function updateBitrateControls()
        {
            var select = document.getElementById("bitrate-type");
            var type = select.value;

            if (type == "video")
            {
                $("#audio-buffer-container").hide();
                $("#video-buffer-container").show();
            }
            else
            {
                $("#audio-buffer-container").show();
                $("#video-buffer-container").hide();
            }
        }

        function mbrUpClicked()
        {
            var select = document.getElementById("bitrate-type");
            var type = select.value;

            if (type == "video")
            {
                var newQuality = player.getVideoQuality() + 1;
                player.setVideoQuality(newQuality);
            }
            else
            {
                var newQuality = player.getAudioQuality() + 1;
                player.setAudioQuality(newQuality);
            }
        }

        function mbrDownClicked()
        {
            var select = document.getElementById("bitrate-type");
            var type = select.value;

            if (type == "video")
            {
                //var newQuality = player.getVideoQuality() - 1;
                //player.setVideoQuality(newQuality);
                player.getVideoQuality().then(
                	function(videoQuality) {
                		if(videoQuality <= 0) {
                			return;
                		}
                		videoQuality = videoQuality - 1;
                		player.setVideoQuality(videoQuality);
                	}
                );
            }
            else
            {
                //var newQuality = player.getAudioQuality() - 1;
              	//player.setAudioQuality(newQuality);
              	player.getAudioQuality().then(
              		function(audioQuality) {
              			if(audioQuality <= 0) {
              				return;
              			}
              			audioQuality = audioQuality - 1;
              			player.setAudioQuality(audioQuality);
              		}
              	);
            }
        }

        function mbrAutoChanged()
        {
            var select = document.getElementById("mbr-auto");
            var doAutoSwitch = select.value;

            if (doAutoSwitch == "true")
            {
                player.setAutoSwitchQuality(true);
            }
            else
            {
                player.setAutoSwitchQuality(false);
            }
        }

        function init()
        {
            $(document).ready(function () {
                $("#mbr-up")
                    .button()
                    .click(function (event) {
                        mbrUpClicked();
                    }
                );

                $("#mbr-down")
                    .button()
                    .click(function (event) {
                        mbrDownClicked();
                    }
                );

                $("#mbr-auto")
                    .click(function (event) {
                        mbrAutoChanged();
                    }
                );

                $("#bitrate-type")
                    .click(function (event) {
                        updateBitrateControls();
                    }
                );

                updateBitrateControls();
            });

            buildVideoBufferGraph();
            buildAudioBufferGraph();
            buildTables();

            Q.longStackJumpLimit = 0;
        }

        function onProgress(e)
        {
            var video = document.querySelector(".dash-video-player video");
            var series, x, y;

            var newTime = Math.floor(video.currentTime);

            if (newTime != time)
            {
                time = newTime;

                var metrics;
                var bitrateValue, bitrateIndex, numBitrates, bufferLength, fragDuration, fragTime, len;

                // video

                metrics = player.getVideoMetrics();

                if (metrics)
                {
                    bitrateValue = document.getElementById("video-value");
                    bitrateValue.innerHTML = (metrics.bitrateValue / 1000) + " kbps";

                    bitrateIndex = document.getElementById("video-index");
                    bitrateIndex.innerHTML = metrics.bitrateIndex + 1;

                    numBitrates = document.getElementById("num-video-bitrates");
                    numBitrates.innerHTML = metrics.maxBitrateIndex;

                    bufferLength = document.getElementById("video-buffer");
                    len = metrics.bufferLength.toString();
                    if (len.length > 5) len = len.substr(0, 4);
                    bufferLength.innerHTML = len + " seconds";

                    fragDuration = document.getElementById("video-frag-duration");
                    len = metrics.lastFragmentDuration.toString();
                    if (len.length > 5) len = len.substr(0, 4);
                    fragDuration.innerHTML = len + " seconds";

                    fragTime = document.getElementById("video-frag-dl-time");
                    fragTime.innerHTML = metrics.lastFragmentDownloadTime + " seconds";

                    series = videoBufferChart.series[0];
                    x = time;
                    y = Math.floor(metrics.bufferLength);
                    series.addPoint([x, y], true, true, false);
                }

                // audio

                metrics = player.getAudioMetrics();

                if (metrics)
                {
                    bitrateValue = document.getElementById("audio-value");
                    bitrateValue.innerHTML = (metrics.bitrateValue / 1000) + " kbps";

                    bitrateIndex = document.getElementById("audio-index");
                    bitrateIndex.innerHTML = metrics.bitrateIndex + 1;

                    numBitrates = document.getElementById("num-audio-bitrates");
                    numBitrates.innerHTML = metrics.maxBitrateIndex;

                    bufferLength = document.getElementById("audio-buffer");
                    len = metrics.bufferLength.toString();
                    if (len.length > 5) len = len.substr(0, 4);
                    bufferLength.innerHTML = len + " seconds";

                    fragDuration = document.getElementById("audio-frag-duration");
                    len = metrics.lastFragmentDuration.toString();
                    if (len.length > 5) len = len.substr(0, 4);
                    fragDuration.innerHTML = len + " seconds";

                    fragTime = document.getElementById("audio-frag-dl-time");
                    fragTime.innerHTML = metrics.lastFragmentDownloadTime + " seconds";

                    series = audioBufferChart.series[0];
                    x = time;
                    y = Math.floor(metrics.bufferLength);
                    series.addPoint([x, y], true, true, false);
                }
            }
        }

        function load()
        {
            // GET VIDEO SOURCE

            var streams = {};

            streams.archive = "http://dash.edgesuite.net/dash264/TestCases/1b/thomson-networks/manifest.mpd";
            streams.live = "http://dashdemo.edgesuite.net/mediaexcel/live/ch1/dash.mpd";
            streams.netflix = "http://dashdemo.edgesuite.net/dash264/TestCases/1a/netflix/exMPD_BIP_TC1.mpd";
            streams.fraunhofer = "http://dashdemo.edgesuite.net/dash264/TestCases/3b/fraunhofer/elephants_dream_heaac2_0.mpd";
            streams.list = "http://www.digitalprimates.net/dash/streams/gpac/mp4-main-multi-mpd-AV-NBS.mpd";
            streams.template = "http://www.digitalprimates.net/dash/streams/mp4-live-template/mp4-live-mpd-AV-BS.mpd";
            streams.timeline = "http://demo.unified-streaming.com/video/ateam/ateam.ism/ateam.mpd";
            streams.base = "http://www.digitalprimates.net/dash/streams/mp4-onDemand/mp4-onDemand-mpd-AV.mpd";
            streams.youtube = "http://yt-dash-mse-test.commondatastorage.googleapis.com/car-20120827-manifest.mpd";
            streams.bunny = "http://dash.edgesuite.net/adobe/bbb/bbb.mpd";
            streams.envivio = "http://dashdemo.edgesuite.net/envivio/dashpr/clear/Manifest.mpd";
            streams.custom = "http://64.105.129.38/manifest.txt";

            var custom = document.getElementById("custom-source"),
                select = document.getElementById("sources"),
                source = null;

            source = custom.value;
            if (source == null || source == "") {
                source = streams[select.value];
                custom.value = source;
            }

			var video = document.querySelector(".dash-video-player video"),
				context = new Dash.di.DashContext(),
				player = new MediaPlayer(context),
				console = document.getElementById("debug_log"),
				debug;

			player.startup();

			debug = player.debug;
			debug.init(console);
			debug.log("manifest | " + source);

			player.autoPlay = true;
			player.attachView(video);
			player.attachSource(source);
        }
    </script>
</head>

<body onload="init()">
    <div class="container_12">
        <div class="grid_6">
            <p>
                1. Select a stream from the drop down or type a mpd location into the input.<br/>
                2. Click on Load.<br/>
                <i>Refresh the page to start a new stream.</i><br/>
            </p>
        </div>

        <div class="grid_6">
            <p>
                If you see the message "manifest failed to load" try turning off Chrome's web security.<br/>
                <i>-Right click the Chrome icon and select "properties".</i><br/>
                <i>-In the "target" field add "--disable-web-security".</i><br/>
                <i>-After launching Chrome you will see the message "You are using an unsupported command-line flag: --disable-web-security.  Stability and security will suffer."</i>
            </p>
        </div>

        <div class="clear"></div>

        <div class="grid_12">
            <hr />
        </div>

        <div class="clear"></div>

        <div class="grid_7">

            <div>
                <div style="float: left;">
                    MPD: <input id="custom-source" style="width:290px;"/>
                </div>
                <div class="video-options" style="float: left;">
                    <select id="sources">
                        <option value="archive">Live Archive</option>
                        <option value="live">Live</option>
                        <option value="envivio" selected="selected">Envivio</option>
                        <option value="netflix">Netflix BaseURL</option>
                        <option value="fraunhofer">Fraunhofer BaseURL</option>
                        <option value="youtube">YouTube SegmentBase</option>
                        <option value="list">Segment List</option>
                        <option value="template">Segment Template</option>
                        <option value="timeline">Segment Timeline</option>
                        <option value="custom">Custom</option>
                        <!--<option value="base">SegmentBase</option>-->
                    </select>
                </div>
                <button type="button" onclick="load()">Load</button>
            </div>

            <div class="dash-video-player" style="width:540px; height:303.75px;">
                <div class="video-wrapper" style="width:540px; height:303.75px;">
                    <video controls="true"></video>
                    <!--
                    <div class="video-controls">
                        <a href="#" class="button-play-pause"></a>
                        <div class="time-current">00:00</div>
                        <div class="scrubber">
                            <div class="progress">
                                <div class="progress-indicator" style="width:1%;"></div>
                                <div class="buffer-indicator" style="width:1%;"></div>
                            </div>
                        </div>
                        <div class="time-total">00:00</div>
                        <a href="#" class="button-full-screen"></a>
                    </div>
                    -->
                </div>
            </div>

        </div>

        <div class="grid_5">
            <div class="grid_2 alpha">
                Bitrate Controls
            </div>
            <div class="grid_1 prefix_2 omega">
                <select id="bitrate-type">
                    <option value="video" selected="selected">Video</option>
                    <option value="audio">Audio</option>
                </select>
            </div>
        </div>

        <div class="grid_5">
            <select id="mbr-auto" class="grid_2 alpha">
                <option value="true">Auto On</option>
                <option value="false">Auto Off</option>
            </select>
            <input id="mbr-up" type="submit" class="grid_1" value="Up" />
            <input id="mbr-down" type="submit" class="grid_1 omega" value="Down" />
        </div>

        <div id="video-buffer-container" class="grid_5" style="width: 380px; height: 200px;"></div>
        <div id="audio-buffer-container" class="grid_5" style="width: 380px; height: 200px;"></div>

        <div class="clear" style="height:10px;"></div>

        <div class="grid_12">
            <table cellpadding="0" cellspacing="0" border="0" class="display" id="metrics-table" width="100%">
                <thead>
                    <tr>
                        <th>Buffer Type</th>
                        <th>Bitrate Value</th>
                        <th>Bitrate Index</th>
                        <th># of Bitrates</th>
                        <th>Buffer Length</th>
                        <th>Last Frag Duration</th>
                        <th>Last Frag D/L Time</th>
                    </tr>
                </thead>

                <tbody>
                    <tr class="gradeA">
                        <td class="center">Video</td>
                        <td id="video-value" class="center">0</td>
                        <td id="video-index" class="center">0</td>
                        <td id="num-video-bitrates" class="center">0</td>
                        <td id="video-buffer" class="center">0</td>
                        <td id="video-frag-duration" class="center">0</td>
                        <td id="video-frag-dl-time" class="center">0</td>
                    </tr>
                    <tr class="gradeC">
                        <td class="center">Audio</td>
                        <td id="audio-value" class="center">0</td>
                        <td id="audio-index" class="center">0</td>
                        <td id="num-audio-bitrates" class="center">0</td>
                        <td id="audio-buffer" class="center">0</td>
                        <td id="audio-frag-duration" class="center">0</td>
                        <td id="audio-frag-dl-time" class="center">0</td>
                    </tr>
                </tbody>
            </table>
        </div>

		<div class="clear"></div>

        <div class="grid_12">
            <br />
            <hr />
        </div>

		<div class="grid_12">
            <h3>Debug Log:</h3>
        </div>

		<div id="debug_log" class="grid_12" style="border:solid 1px; height: 303px; overflow: auto;">
            Waiting...
        </div>

        <div class="clear"></div>

        <div class="grid_12">
            <br />
            <hr />
        </div>

        <div class="clear"></div>

        <div class="grid_12">
            <b>Known Issues</b><br/>
            Erratic playback at higher bitrates.<br/>
            Streams using high profile codecs may not play properly.<br/>
            You may get the error "Media Source Close" when attempting to switch bitrates.<br/>
            Only streams with segmentAlignment="true" will work with MBR.
        </div>

        <div class="clear" style="height:10px;"></div>

        <div class="grid_12">
            <b>Release Notes v0.1.1</b><br/>
            Metrics first pass.<br/>
            Live first pass (still not working).<br/>
            ABR first pass.<br/>
            If a buffer runs dry playback stalls until more data is loaded.<br/>
            Fix some (maybe not all) performance issues.<br/>
            Change copyright information.
        </div>

		<div class="clear" style="height:10px;"></div>

        <div class="grid_12">
            <b>Release Notes v0.1.0</b><br/>
            Major architecture changes.<br/>
            Moved a lot of code around to make smaller overall objects.<br/>
            Implemented Promises to make everything async.<br/>
            Implemented DI for easy overriding of objects.<br/>
            Added more logging.<br/>
            <b>Metrics are not currently implemented.</b><br/>
            <b>Auto ABR is not yet working due to metrics dependancy.</b>
        </div>

		<div class="clear" style="height:10px;"></div>

        <div class="grid_12">
            <b>Release Notes v0.0.7</b><br/>
            Changes for structure and contents of JavaScript files.</br>
            <i>-Scope is now better isolated.</i></br>
            <i>-Better patterns for object creation.</i></br>
            <i>-Overall cleaner code.</i>
        </div>

        <div class="clear" style="height:10px;"></div>

        <div class="grid_12">
            <b>Release Notes v0.0.6</b><br/>
            UI changes.
        </div>

        <div class="clear" style="height:10px;"></div>

        <div class="grid_12">
            <b>Release Notes v0.0.5</b><br/>
            Flesh out MBR support.<br/>
            Add architecture for rule checking.<br/>
            Add basic bandwidth rule.<br/>
            <b>Introduced a limitation: only streams with segmentAlignment="true" will work with MBR.</b>
        </div>

        <div class="clear" style="height:10px;"></div>

        <div class="grid_12">
            <b>Release Notes v0.0.4</b><br/>
            Add metrics bling.<br/>
            Expose methods to change audio bitrate.<br/>
            Play video automatically after loading completes.<br/>
        </div>

        <div class="clear" style="height:10px;"></div>

        <div class="grid_12">
            <b>Release Notes v0.0.3</b><br/>
            Handle BaseURL with no SegmentTemplate, SegmentList, or SegmentBase.<br/>
            Handle SegmentBase nodes without an indexRange or initializationRange.<br/>
        </div>

        <div class="clear" style="height:10px;"></div>

        <div class="grid_12">
            <b>Release Notes v0.0.2</b><br/>
            Rearchitect the application for better extensibility.<br/>
            Properly signal end of stream.<br/>
            Add metrics tracking.<br/>
            Add charts and tables with metrics info.<br/>
        </div>

        <div class="clear" style="height:10px;"></div>

        <div class="grid_12">
            <b>Release Notes v0.0.1</b><br/>
            Requires Chrome 24 or later.<br/>
            Basic implements for the four fragment description types work.<br/>
            <i>SegmentList</i><br/>
            <i>SegmentTemplate</i><br/>
            <i>SegmentTemplate with SegmentTimeline</i><br/>
            <i>SegmentBase</i><br/>
        </div>

        <div class="clear" style="height:10px;"></div>
    </div>
</body>
</html>